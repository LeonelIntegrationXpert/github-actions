#################################################################################################
# MuleSoft CI/CD Pipeline - GitHub Actions Workflow
#################################################################################################
# Projeto   : github-actions
# Autor     : Leonel Dorneles Porto
# Email     : leoneldornelesporto@outlook.com.br
# Telefone  : +55 53 99180-4869
#################################################################################################
# DescriÃ§Ã£o :
#   - Pipeline de CI/CD para MuleSoft com deploy no CloudHub 2.0 e publicaÃ§Ã£o no Exchange.
#################################################################################################

name: Publish to Exchange & Deploy to CH2.0

on:
  push:
    branches: 
      - dev
      - qa
      - prod

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      #########################################################################
      # Passo 1: Checkout do repositÃ³rio
      #########################################################################
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # necessÃ¡rio para obter todo o histÃ³rico da branch

      #########################################################################
      # Passo 2: Configurar JDK 17
      #########################################################################
      - name: â˜• Configurando JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: 17

      #########################################################################
      # Passo 3: Incrementar a versÃ£o do projeto na branch atual
      #########################################################################
      - name: ğŸ”– Incrementar versÃ£o do pom.xml (apenas branch atual)
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ InÃ­cio do incremento de versÃ£o"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          BRANCH_ATUAL=$GITHUB_REF_NAME
          echo "ğŸŒ¿ Branch atual: $BRANCH_ATUAL"

          git fetch origin $BRANCH_ATUAL
          git checkout $BRANCH_ATUAL || git checkout -b $BRANCH_ATUAL origin/$BRANCH_ATUAL
          git pull origin $BRANCH_ATUAL

          echo "ğŸ” Buscando versÃ£o atual no pom.xml"
          VERSAO_ATUAL=$(grep -m 1 '<version>' pom.xml | sed -E 's/.*<version>(.*)<\/version>.*/\1/')
          echo "ğŸ“Œ VersÃ£o atual: $VERSAO_ATUAL"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSAO_ATUAL"
          NOVO_PATCH=$((PATCH + 1))
          NOVA_VERSAO="${MAJOR}.${MINOR}.${NOVO_PATCH}"
          echo "ğŸš€ Nova versÃ£o: $NOVA_VERSAO"

          sed -i "0,/<version>.*<\/version>/s//<version>${NOVA_VERSAO}<\/version>/" pom.xml
          echo "ğŸ”– VersÃ£o atualizada no pom.xml"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add pom.xml
          git commit -m "ğŸ”– Bump version to $NOVA_VERSAO [automated by CI/CD]"
          git push origin $BRANCH_ATUAL

          echo "âœ… VersÃ£o $NOVA_VERSAO publicada na branch $BRANCH_ATUAL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      #########################################################################
      # Passo 4: Cache das dependÃªncias Maven
      #########################################################################
      - name: ğŸ“¦ Cache de dependÃªncias Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      #########################################################################
      # Passo 5: PublicaÃ§Ã£o no Anypoint Exchange
      #########################################################################
      - name: ğŸš€ Publicar no Anypoint Exchange
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Publicando no Anypoint Exchange - Ambiente: $GITHUB_REF_NAME"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          mvn deploy --settings .maven/settings.xml -P $GITHUB_REF_NAME -DskipMunitTests \
            -Dclient.id="${{ secrets.CONNECTED_APP_CLIENT_ID }}" \
            -Dclient.secret="${{ secrets.CONNECTED_APP_CLIENT_SECRET }}"

          echo "âœ… PublicaÃ§Ã£o no Exchange concluÃ­da!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      #########################################################################
      # Passo 6: Deploy no CloudHub 2.0
      #########################################################################
      - name: â˜ï¸ Deploy no CloudHub 2.0
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â˜ï¸ Iniciando deploy no CloudHub 2.0 - Ambiente: $GITHUB_REF_NAME"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          mvn deploy --settings .maven/settings.xml -P $GITHUB_REF_NAME -DskipMunitTests -DmuleDeploy \
            -Dclient.id="${{ secrets.CONNECTED_APP_CLIENT_ID }}" \
            -Dclient.secret="${{ secrets.CONNECTED_APP_CLIENT_SECRET }}"

          echo "âœ… Deploy no CloudHub 2.0 concluÃ­do com sucesso!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
