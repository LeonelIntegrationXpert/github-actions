#################################################################################################
# MuleSoft CI/CD Pipeline - GitHub Actions Workflow
#################################################################################################
# Projeto   : github-actions
# Autor     : Leonel Dorneles Porto
# Email     : leoneldornelesporto@outlook.com.br
# Telefone  : +55 53 99180-4869
#################################################################################################
# DescriÃ§Ã£o :
#   - Pipeline de CI/CD para MuleSoft, com controle de versÃ£o unificado em mÃºltiplas branches.
#################################################################################################

name: Publish to Exchange & Deploy to CH2.0

on:
  push:
    branches: 
      - dev
      - qa
      - prod
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      #########################################################################
      # Passo 1: Checkout de todas as branches com histÃ³rico completo
      #########################################################################
      - name: ğŸ“¥ Checkout do repositÃ³rio completo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # necessÃ¡rio para mÃºltiplas branches e merge

      #########################################################################
      # Passo 2: Configurar JDK 17
      #########################################################################
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: 17

      #########################################################################
      # Passo 3: Incrementar a versÃ£o a partir da branch atual e propagar
      #########################################################################
      - name: ğŸ”– Incrementar versÃ£o do pom.xml e propagar para outras branches
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ InÃ­cio do incremento de versÃ£o a partir da branch atual"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Branch de origem onde o push aconteceu
          ORIGIN_BRANCH=$GITHUB_REF_NAME
          echo "ğŸŒ¿ Branch de origem: $ORIGIN_BRANCH"

          # Todas as branches que queremos manter sincronizadas
          TARGET_BRANCHES="dev qa prod main"

          # Checkout da branch de origem
          echo "ğŸ”„ Fazendo checkout da branch de origem $ORIGIN_BRANCH"
          git fetch origin $ORIGIN_BRANCH
          git checkout $ORIGIN_BRANCH || git checkout -b $ORIGIN_BRANCH origin/$ORIGIN_BRANCH
          git pull origin $ORIGIN_BRANCH

          # Pegando a versÃ£o atual do pom.xml
          echo "ğŸ” Buscando versÃ£o atual no pom.xml da branch $ORIGIN_BRANCH"
          BASE_VERSION=$(grep -m 1 '<version>' pom.xml | sed -E 's/.*<version>(.*)<\/version>.*/\1/')
          echo "ğŸ“Œ VersÃ£o atual detectada: $BASE_VERSION"

          # Fazendo o incremento da versÃ£o apenas UMA vez
          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
          echo "ğŸš€ Nova versÃ£o: $NEW_VERSION"

          # Atualizando o pom.xml na branch de origem
          sed -i "0,/<version>.*<\/version>/s//<version>${NEW_VERSION}<\/version>/" pom.xml
          grep -m 1 '<version>' pom.xml

          # Comitando e enviando para a branch de origem
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add pom.xml
          git commit -m "ğŸ”– Bump version to $NEW_VERSION [automated by CI/CD]"
          git push origin $ORIGIN_BRANCH

          ###################################################################
          # Agora propaga a mesma versÃ£o para as demais branches
          ###################################################################
          for BRANCH in $TARGET_BRANCHES
          do
            # Pula a branch de origem (jÃ¡ foi atualizada)
            if [ "$BRANCH" = "$ORIGIN_BRANCH" ]; then
              echo "âš ï¸ Ignorando branch de origem $BRANCH"
              continue
            fi

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸŒ¿ Processando branch: $BRANCH"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            git fetch origin $BRANCH
            git checkout $BRANCH || git checkout -b $BRANCH origin/$BRANCH
            git pull origin $BRANCH

            # Atualiza o pom.xml com a MESMA nova versÃ£o
            sed -i "0,/<version>.*<\/version>/s//<version>${NEW_VERSION}<\/version>/" pom.xml
            grep -m 1 '<version>' pom.xml

            git add pom.xml
            git commit -m "ğŸ”– Bump version to $NEW_VERSION [automated by CI/CD]"
            git push origin $BRANCH

            echo "âœ… AtualizaÃ§Ã£o concluÃ­da na branch: $BRANCH"
          done

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Todas as branches foram sincronizadas com a versÃ£o: $NEW_VERSION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      #########################################################################
      # Passo 5: PublicaÃ§Ã£o no Anypoint Exchange
      #########################################################################
      - name: ğŸš€ Publicar no Anypoint Exchange
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Publicando no Anypoint Exchange"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          echo "ğŸ“‚ Ambiente detectado: $GITHUB_REF_NAME"

          mvn deploy --settings .maven/settings.xml -P $GITHUB_REF_NAME -DskipMunitTests \
            -Dclient.id="${{ secrets.CONNECTED_APP_CLIENT_ID }}" \
            -Dclient.secret="${{ secrets.CONNECTED_APP_CLIENT_SECRET }}"

          echo "âœ… PublicaÃ§Ã£o no Exchange concluÃ­da!"

      #########################################################################
      # Passo 6: Deploy no CloudHub 2.0
      #########################################################################
      - name: â˜ï¸ Deploy no CloudHub 2.0
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â˜ï¸ Iniciando deploy no CloudHub 2.0"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          echo "ğŸ“‚ Ambiente detectado: $GITHUB_REF_NAME"

          mvn deploy --settings .maven/settings.xml -P $GITHUB_REF_NAME -DskipMunitTests -DmuleDeploy \
            -Dclient.id="${{ secrets.CONNECTED_APP_CLIENT_ID }}" \
            -Dclient.secret="${{ secrets.CONNECTED_APP_CLIENT_SECRET }}"

          echo "âœ… Deploy no CloudHub 2.0 realizado com sucesso!"
