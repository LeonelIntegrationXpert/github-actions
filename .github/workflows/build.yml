name: Publish to Exchange & Deploy to CH2.0

on:
  push:
    branches: [ main ]

permissions:
  contents: write  # Necess√°rio para fazer commits e pushes

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Setup JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: 8

      # üëâ Passo: Buscar a vers√£o atual no pom.xml e incrementar PATCH
      - name: üîñ Incrementar vers√£o do pom.xml
        run: |
          echo "üîç Pegando vers√£o do pom.xml..."
          VERSION=$(grep -m 1 '<version>' pom.xml | sed -E 's/.*<version>(.*)<\/version>.*/\1/')

          echo "Vers√£o atual: $VERSION"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "üöÄ Nova vers√£o: $NEW_VERSION"

          # Substituir no pom.xml
          sed -i "0,/<version>.*<\/version>/s//<version>${NEW_VERSION}<\/version>/" pom.xml

          # Confirmando que alterou
          grep -m 1 '<version>' pom.xml

          # Faz commit e push com a nova vers√£o
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add pom.xml
          git commit -m "üîñ Bump version to $NEW_VERSION"
          git push

      - name: üöÄ Publicar no Anypoint Exchange
        run: |
          mvn deploy --settings .maven/settings.xml -DskipMunitTests \
          -Dclient.id="${{ secrets.CONNECTED_APP_CLIENT_ID }}" \
          -Dclient.secret="${{ secrets.CONNECTED_APP_CLIENT_SECRET }}"

      - name: ‚òÅÔ∏è Deploy no CloudHub 2.0
        run: |
          mvn deploy --settings .maven/settings.xml -DskipMunitTests -DmuleDeploy \
          -Dclient.id="${{ secrets.CONNECTED_APP_CLIENT_ID }}" \
          -Dclient.secret="${{ secrets.CONNECTED_APP_CLIENT_SECRET }}"
