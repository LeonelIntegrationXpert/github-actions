#################################################################################################
# MuleSoft CI/CD Pipeline - GitHub Actions Workflow
#################################################################################################
# Projeto   : github-actions
# Autor     : Leonel Dorneles Porto
# Email     : leoneldornelesporto@outlook.com.br
# Telefone  : +55 53 99180-4869
#################################################################################################
# DescriÃ§Ã£o :
#   - Pipeline de CI/CD para aplicaÃ§Ãµes MuleSoft 4.x, utilizando GitHub Actions.
#   - Automatiza o processo de build, testes MUnit, publicaÃ§Ã£o no Anypoint Exchange
#     e deploy no CloudHub 2.0.
#   - Inclui incremento automÃ¡tico de versÃ£o no pom.xml (sem necessidade de intervenÃ§Ã£o manual).
#
# Funcionalidades :
#   âœ… Build e package da aplicaÃ§Ã£o MuleSoft
#   âœ… ExecuÃ§Ã£o de testes MUnit com cobertura de cÃ³digo (opcional)
#   âœ… PublicaÃ§Ã£o de assets no Anypoint Exchange
#   âœ… Deploy automÃ¡tico no CloudHub 2.0 com Rolling Updates e OSv2
#   âœ… Controle de variÃ¡veis e segredos via GitHub Secrets
#   âœ… Incremento automÃ¡tico da versÃ£o no pom.xml (exemplo: 1.0.0 -> 1.0.1)
#
#################################################################################################
# DocumentaÃ§Ã£o oficial MuleSoft:
#   https://docs.mulesoft.com/mule-runtime/4.4/
# GitHub Actions - Quickstart:
#   https://docs.github.com/pt/actions/writing-workflows/quickstart
# Video referÃªncia - Alex Martinez (ProstDev):
#   https://www.youtube.com/watch?v=hfQaYcjUB9c
#################################################################################################

name: Publish to Exchange & Deploy to CH2.0

on:
  push:
    branches: [ dev ]  # ğŸš€ Aciona a pipeline automaticamente em pushes no branch `main`

permissions:
  contents: write  # ğŸ”“ PermissÃ£o necessÃ¡ria para modificar arquivos (ex: pom.xml) e fazer commits

jobs:
  build:
    runs-on: ubuntu-latest  # ğŸ–¥ï¸ Define o ambiente de execuÃ§Ã£o (Ubuntu mais recente)

    steps:
      # ğŸ“Œ Passo 1: Fazer o checkout do repositÃ³rio para obter o cÃ³digo-fonte
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      # ğŸ“Œ Passo 2: Habilitar cache do Maven para evitar downloads desnecessÃ¡rios e acelerar builds
      - name: ğŸ“¦ Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository  # ğŸ”„ Pasta do cache do Maven
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}  # ğŸ”‘ Cache baseado no `pom.xml`
          restore-keys: ${{ runner.os }}-maven-  # ğŸ”„ Tenta reutilizar caches antigos se possÃ­vel

      # ğŸ“Œ Passo 3: Configurar JDK 8 (necessÃ¡rio para MuleSoft 4.x)
      - name: â˜• Setup JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"  # ğŸ”¹ Azul Zulu OpenJDK, recomendado para MuleSoft
          java-version: 8  # ğŸ”¢ VersÃ£o do Java exigida pelo MuleSoft

      # ğŸ“Œ Passo 4: Incrementar automaticamente a versÃ£o no pom.xml
      - name: ğŸ”– Incrementar versÃ£o do pom.xml
        run: |
          echo "ğŸ” Pegando versÃ£o do pom.xml..."
          VERSION=$(grep -m 1 '<version>' pom.xml | sed -E 's/.*<version>(.*)<\/version>.*/\1/')

          echo "ğŸ“Œ VersÃ£o atual: $VERSION"

          # ğŸ› ï¸ Separando versÃ£o em MAJOR.MINOR.PATCH
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # ğŸ”¼ Incrementando PATCH (exemplo: 1.0.0 â†’ 1.0.1)
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "ğŸš€ Nova versÃ£o: $NEW_VERSION"

          # ğŸ“ Substituir a versÃ£o no `pom.xml`
          sed -i "0,/<version>.*<\/version>/s//<version>${NEW_VERSION}<\/version>/" pom.xml

          # ğŸ” Confirmar a alteraÃ§Ã£o
          grep -m 1 '<version>' pom.xml

          # ğŸ”„ Configurar Git para commit automÃ¡tico da nova versÃ£o
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # ğŸ“¤ Commit e push da nova versÃ£o
          git add pom.xml
          git commit -m "ğŸ”– Bump version to $NEW_VERSION"
          
          # ğŸ”¥ Empurra pro branch atual que disparou o workflow
          git push origin HEAD:${GITHUB_REF#refs/heads/}

      # ğŸ“Œ Passo 5: Publicar no Anypoint Exchange para versionamento do asset
      - name: ğŸš€ Publicar no Anypoint Exchange (Dev)
        run: |
          mvn deploy --settings .maven/settings.xml -P dev -DskipMunitTests \
          -Dclient.id="${{ secrets.CONNECTED_APP_CLIENT_ID }}" \
          -Dclient.secret="${{ secrets.CONNECTED_APP_CLIENT_SECRET }}"

      # ğŸ“Œ Passo 6: Realizar deploy no CloudHub 2.0
      - name: â˜ï¸ Deploy no CloudHub 2.0 (Dev)
        run: |
          mvn deploy --settings .maven/settings.xml -P dev -DskipMunitTests -DmuleDeploy \
          -Dclient.id="${{ secrets.CONNECTED_APP_CLIENT_ID }}" \
          -Dclient.secret="${{ secrets.CONNECTED_APP_CLIENT_SECRET }}"
