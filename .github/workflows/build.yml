#################################################################################################
# MuleSoft CI/CD Pipeline - GitHub Actions Workflow
#################################################################################################
# Projeto   : github-actions
# Autor     : Leonel Dorneles Porto
# Email     : leoneldornelesporto@outlook.com.br
# Telefone  : +55 53 99180-4869
#################################################################################################
# DescriÃ§Ã£o :
#   - Pipeline de CI/CD para aplicaÃ§Ãµes MuleSoft 4.x, utilizando GitHub Actions.
#   - Automatiza o processo de build, testes MUnit, publicaÃ§Ã£o no Anypoint Exchange
#     e deploy no CloudHub 2.0.
#   - Inclui incremento automÃ¡tico de versÃ£o no pom.xml (sem necessidade de intervenÃ§Ã£o manual).
#
#################################################################################################
# Funcionalidades :
#   âœ… Build e package da aplicaÃ§Ã£o MuleSoft
#   âœ… ExecuÃ§Ã£o de testes MUnit com cobertura de cÃ³digo (opcional)
#   âœ… PublicaÃ§Ã£o de assets no Anypoint Exchange
#   âœ… Deploy automÃ¡tico no CloudHub 2.0 com Rolling Updates e OSv2
#   âœ… Controle de variÃ¡veis e segredos via GitHub Secrets
#   âœ… Incremento automÃ¡tico da versÃ£o no pom.xml (exemplo: 1.0.0 -> 1.0.1)
#
#################################################################################################
# DocumentaÃ§Ã£o oficial MuleSoft:
#   https://docs.mulesoft.com/mule-runtime/4.4/
# GitHub Actions - Quickstart:
#   https://docs.github.com/pt/actions/writing-workflows/quickstart
# Video referÃªncia - Alex Martinez (ProstDev):
#   https://www.youtube.com/watch?v=hfQaYcjUB9c
#################################################################################################

name: Publish to Exchange & Deploy to CH2.0

on:
  push:
    branches: 
      - dev
      - qa
      - prod
      - main  # Inclui se quiser deploy em outras branches tambÃ©m

permissions:
  contents: write  # ğŸ”“ PermissÃ£o necessÃ¡ria para modificar arquivos (ex: pom.xml) e fazer commits

jobs:
  build:
    runs-on: ubuntu-latest  # ğŸ–¥ï¸ Ambiente de execuÃ§Ã£o no GitHub Actions

    steps:
      # ğŸ“Œ Passo 1: Fazer o checkout do repositÃ³rio
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      # ğŸ“Œ Passo 2: Cache de dependÃªncias Maven
      - name: ğŸ“¦ Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      # ğŸ“Œ Passo 3: Configurar JDK 8
      - name: â˜• Setup JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: 8

      # ğŸ“Œ Passo 4: Incrementar versÃ£o automaticamente no pom.xml
      - name: ğŸ”– Incrementar versÃ£o do pom.xml
        run: |
          echo "ğŸ” Pegando versÃ£o do pom.xml..."
          VERSION=$(grep -m 1 '<version>' pom.xml | sed -E 's/.*<version>(.*)<\/version>.*/\1/')
          
          echo "ğŸ“Œ VersÃ£o atual: $VERSION"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "ğŸš€ Nova versÃ£o: $NEW_VERSION"

          sed -i "0,/<version>.*<\/version>/s//<version>${NEW_VERSION}<\/version>/" pom.xml

          grep -m 1 '<version>' pom.xml

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add pom.xml
          git commit -m "ğŸ”– Bump version to $NEW_VERSION"

          # ğŸ”„ Faz pull com rebase para evitar conflitos antes de empurrar
          git pull --rebase origin $GITHUB_REF_NAME
          
          # ğŸš€ Push automÃ¡tico para a branch atual
          git push origin $GITHUB_REF_NAME

      # ğŸ“Œ Passo 5: PublicaÃ§Ã£o no Anypoint Exchange
      - name: ğŸš€ Publicar no Anypoint Exchange
        run: |
          echo "ğŸŒ Ambiente detectado: $GITHUB_REF_NAME"
          mvn deploy --settings .maven/settings.xml -P $GITHUB_REF_NAME -DskipMunitTests \
            -Dclient.id="${{ secrets.CONNECTED_APP_CLIENT_ID }}" \
            -Dclient.secret="${{ secrets.CONNECTED_APP_CLIENT_SECRET }}"

      # ğŸ“Œ Passo 6: Deploy no CloudHub 2.0
      - name: â˜ï¸ Deploy no CloudHub 2.0
        run: |
          echo "ğŸŒ Ambiente detectado: $GITHUB_REF_NAME"
          mvn deploy --settings .maven/settings.xml -P $GITHUB_REF_NAME -DskipMunitTests -DmuleDeploy \
            -Dclient.id="${{ secrets.CONNECTED_APP_CLIENT_ID }}" \
            -Dclient.secret="${{ secrets.CONNECTED_APP_CLIENT_SECRET }}"
